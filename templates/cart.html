{% extends "layout.html" %}

{% block title %}Carrinho{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Seu Carrinho</h2>
    
    {% if not cart or cart.get_item_count() == 0 %}
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-shopping-cart fa-4x text-muted mb-3"></i>
                        <h4>Seu carrinho está vazio</h4>
                        <p class="text-muted">Adicione itens do cardápio para fazer seu pedido</p>
                        <a href="{{ url_for('index') }}" class="btn btn-primary mt-3">
                            <i class="fas fa-utensils"></i> Explorar Restaurantes
                        </a>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <div class="row">
            <!-- Itens do Carrinho -->
            <div class="col-md-8">
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">{{ cart.restaurant.name }}</h5>
                        <form method="POST" action="{{ url_for('clear_cart') }}" style="display: inline;">
                            <button type="submit" class="btn btn-sm btn-outline-danger" 
                                    onclick="return confirm('Tem certeza que deseja limpar o carrinho?')">
                                <i class="fas fa-trash"></i> Limpar Carrinho
                            </button>
                        </form>
                    </div>
                    <div class="card-body">
                        {% for item in cart.items %}
                        <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">{{ item.menu_item.name }}</h6>
                                <p class="text-muted mb-1 small">{{ item.menu_item.description }}</p>
                                <strong class="text-success">R$ {{ "%.2f"|format(item.price) }}</strong>
                            </div>
                            
                            <div class="d-flex align-items-center">
                                <!-- Controles de Quantidade -->
                                <div class="btn-group me-3" role="group">
                                    <form method="POST" action="{{ url_for('update_cart_item') }}" style="display: inline;">
                                        <input type="hidden" name="item_id" value="{{ item.id }}">
                                        <input type="hidden" name="quantity" value="{{ item.quantity - 1 }}">
                                        <button type="submit" class="btn btn-outline-secondary btn-sm" 
                                                {% if item.quantity <= 1 %}disabled{% endif %}>
                                            <i class="fas fa-minus"></i>
                                        </button>
                                    </form>
                                    
                                    <span class="btn btn-outline-secondary btn-sm disabled">{{ item.quantity }}</span>
                                    
                                    <form method="POST" action="{{ url_for('update_cart_item') }}" style="display: inline;">
                                        <input type="hidden" name="item_id" value="{{ item.id }}">
                                        <input type="hidden" name="quantity" value="{{ item.quantity + 1 }}">
                                        <button type="submit" class="btn btn-outline-secondary btn-sm">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </form>
                                </div>
                                
                                <!-- Subtotal do Item -->
                                <div class="text-end me-3">
                                    <strong>R$ {{ "%.2f"|format(item.get_subtotal()) }}</strong>
                                </div>
                                
                                <!-- Remover Item -->
                                <form method="POST" action="{{ url_for('remove_from_cart') }}" style="display: inline;">
                                    <input type="hidden" name="item_id" value="{{ item.id }}">
                                    <button type="submit" class="btn btn-outline-danger btn-sm" 
                                            onclick="return confirm('Remover este item do carrinho?')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Continuar Comprando -->
                <div class="mb-3">
                    <a href="{{ url_for('restaurant', restaurant_id=cart.restaurant_id) }}" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left"></i> Continuar Comprando
                    </a>
                </div>

                {% if available_items %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Produtos disponíveis neste restaurante</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            {% for mi in available_items %}
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <img src="{{ mi.image_url or url_for('static', filename='images/food-placeholder.jpg') }}" alt="{{ mi.name }}" class="card-img-top" style="height: 160px; object-fit: cover;" onerror="this.onerror=null;this.src='{{ url_for('static', filename='images/food-placeholder.jpg') }}'">
                                    <div class="card-body d-flex flex-column">
                                        <h6 class="card-title mb-1">{{ mi.name }}</h6>
                                        {% if mi.description %}
                                        <p class="card-text text-muted small">{{ mi.description }}</p>
                                        {% endif %}
                                        <div class="mt-auto d-flex justify-content-between align-items-center">
                                            <strong>R$ {{ "%.2f"|format(mi.price) }}</strong>
                                            <form method="GET" action="{{ url_for('add_to_cart') }}">
                                                <input type="hidden" name="item_id" value="{{ mi.id }}">
                                                <input type="hidden" name="quantity" value="1">
                                                <button type="submit" class="btn btn-sm btn-danger"><i class="fas fa-plus"></i> Adicionar</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- Resumo do Pedido -->
            <div class="col-md-4">
                <div class="card sticky-top">
                    <div class="card-header">
                        <h5 class="mb-0">Resumo do Pedido</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal ({{ cart.get_item_count() }} {% if cart.get_item_count() == 1 %}item{% else %}itens{% endif %}):</span>
                            <span>R$ {{ "%.2f"|format(cart.get_total()) }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Taxa de entrega:</span>
                            <span>R$ {{ "%.2f"|format(cart.restaurant.delivery_fee) }}</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between mb-3">
                            <h6>Total:</h6>
                            <h6>R$ {{ "%.2f"|format(cart.get_total() + cart.restaurant.delivery_fee) }}</h6>
                        </div>
                        
                        <div class="d-grid">
                            <a href="{{ url_for('checkout') }}" class="btn btn-success btn-lg">
                                <i class="fas fa-check"></i> Finalizar Pedido
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- Informações de Entrega -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="mb-0">Informações de Entrega</h6>
                    </div>
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-clock text-muted me-2"></i>
                            <span>{{ cart.restaurant.delivery_time }} min</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <i class="fas fa-star text-warning me-2"></i>
                            <span>{{ cart.restaurant.rating }} ({{ cart.restaurant.name }})</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<style>
.sticky-top {
    top: 20px;
}

.btn-group .btn {
    min-width: 35px;
}

.border-bottom:last-child {
    border-bottom: none !important;
}
</style>
{% endblock %}
